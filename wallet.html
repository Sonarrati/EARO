<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet - EARO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--darker);
            color: var(--light);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .back-btn {
            color: #94a3b8;
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease;
        }

        .back-btn:hover {
            color: white;
        }

        /* Wallet Overview */
        .wallet-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .wallet-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .wallet-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .wallet-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .wallet-icon {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .wallet-icon.main {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .wallet-icon.bonus {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
        }

        .wallet-icon.purchase {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
        }

        .wallet-info h3 {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 5px;
        }

        .wallet-amount {
            font-size: 32px;
            font-weight: 700;
            color: white;
        }

        .wallet-actions {
            margin-top: 20px;
        }

        .wallet-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .wallet-btn.primary {
            background: var(--gradient);
            color: white;
        }

        .wallet-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .wallet-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-top: 10px;
        }

        /* Withdrawal Section */
        .withdrawal-section {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 24px;
            color: white;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .withdrawal-form {
            max-width: 500px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: 500;
            font-size: 14px;
        }

        .input-group {
            position: relative;
        }

        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        input, select {
            width: 100%;
            padding: 15px 15px 15px 45px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .amount-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .amount-option {
            padding: 12px;
            text-align: center;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .amount-option:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }

        .amount-option.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
            color: var(--primary);
        }

        .withdrawal-btn {
            width: 100%;
            padding: 15px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .withdrawal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .withdrawal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .withdrawal-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 10px;
            color: #93c5fd;
            font-size: 14px;
        }

        /* Transactions */
        .transactions-section {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .transactions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .filter-tab.active {
            background: var(--gradient);
            color: white;
            border-color: transparent;
        }

        .transactions-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            transition: background 0.3s ease;
        }

        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .transaction-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .transaction-icon.earning {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent);
        }

        .transaction-icon.withdrawal {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .transaction-icon.bonus {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .transaction-details h4 {
            color: white;
            margin-bottom: 5px;
        }

        .transaction-details p {
            color: #94a3b8;
            font-size: 14px;
        }

        .transaction-amount {
            text-align: right;
        }

        .transaction-amount .amount {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .transaction-amount .status {
            font-size: 12px;
            margin-top: 5px;
        }

        .status.pending {
            color: var(--warning);
        }

        .status.approved {
            color: var(--accent);
        }

        .status.rejected {
            color: var(--danger);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #94a3b8;
            text-decoration: none;
            font-size: 12px;
            gap: 5px;
            transition: all 0.3s ease;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item:hover {
            color: white;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .loading.active {
            display: block;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--dark);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        .modal-header {
            margin-bottom: 30px;
        }

        .modal-header h3 {
            font-size: 24px;
            color: white;
            margin-bottom: 10px;
        }

        .modal-content {
            color: #94a3b8;
            margin-bottom: 30px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
        }

        .modal-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.confirm {
            background: var(--gradient);
            color: white;
        }

        .modal-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        @media (max-width: 768px) {
            .wallet-overview {
                grid-template-columns: 1fr;
            }
            
            .transactions-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .transaction-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .transaction-amount {
                text-align: left;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">EARO</div>
            <a href="dashboard.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>Loading wallet data...</p>
        </div>

        <!-- Wallet Overview -->
        <div class="wallet-overview">
            <div class="wallet-card">
                <div class="wallet-header">
                    <div class="wallet-icon main">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="wallet-info">
                        <h3>Main Balance</h3>
                        <div class="wallet-amount" id="mainBalance">₹0.00</div>
                    </div>
                </div>
                <div class="wallet-actions">
                    <button class="wallet-btn primary" onclick="withdrawFunds()">
                        <i class="fas fa-download"></i> Withdraw
                    </button>
                    <button class="wallet-btn secondary" onclick="showAddFundsModal()">
                        <i class="fas fa-plus"></i> Add Funds
                    </button>
                </div>
            </div>
            
            <div class="wallet-card">
                <div class="wallet-header">
                    <div class="wallet-icon bonus">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div class="wallet-info">
                        <h3>Bonus Balance</h3>
                        <div class="wallet-amount" id="bonusBalance">₹0.00</div>
                    </div>
                </div>
                <div class="wallet-actions">
                    <button class="wallet-btn secondary" disabled>
                        <i class="fas fa-info-circle"></i> Non-Withdrawable
                    </button>
                    <small style="color: #94a3b8; display: block; margin-top: 10px; font-size: 12px;">
                        Use for purchases and referrals
                    </small>
                </div>
            </div>
            
            <div class="wallet-card">
                <div class="wallet-header">
                    <div class="wallet-icon purchase">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="wallet-info">
                        <h3>Purchase Balance</h3>
                        <div class="wallet-amount" id="purchaseBalance">₹0.00</div>
                    </div>
                </div>
                <div class="wallet-actions">
                    <button class="wallet-btn primary" onclick="window.location.href='plans.html'">
                        <i class="fas fa-gem"></i> Buy Plans
                    </button>
                    <button class="wallet-btn secondary" onclick="showAddFundsModal()">
                        <i class="fas fa-plus"></i> Add Funds
                    </button>
                </div>
            </div>
        </div>

        <!-- Withdrawal Section -->
        <div class="withdrawal-section">
            <h2 class="section-title"><i class="fas fa-download"></i> Withdraw Funds</h2>
            
            <div class="withdrawal-form">
                <div class="form-group">
                    <label for="withdrawalAmount">Amount (₹)</label>
                    <div class="input-group">
                        <i class="fas fa-rupee-sign"></i>
                        <input type="number" id="withdrawalAmount" placeholder="Enter amount" min="100" max="250">
                    </div>
                    <div class="amount-options">
                        <div class="amount-option" onclick="setAmount(100)">₹100</div>
                        <div class="amount-option" onclick="setAmount(150)">₹150</div>
                        <div class="amount-option active" onclick="setAmount(200)">₹200</div>
                        <div class="amount-option" onclick="setAmount(250)">₹250</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="upiId">UPI ID</label>
                    <div class="input-group">
                        <i class="fas fa-mobile-alt"></i>
                        <input type="text" id="upiId" placeholder="example@upi">
                    </div>
                </div>
                
                <button class="withdrawal-btn" id="withdrawBtn" onclick="requestWithdrawal()">
                    <i class="fas fa-paper-plane"></i> Request Withdrawal
                </button>
                
                <div class="withdrawal-info">
                    <i class="fas fa-info-circle"></i>
                    Minimum withdrawal: ₹100 | Maximum per day: ₹250 | Processing time: 24-48 hours
                </div>
            </div>
        </div>

        <!-- Transactions Section -->
        <div class="transactions-section">
            <div class="transactions-header">
                <h2 class="section-title"><i class="fas fa-history"></i> Transaction History</h2>
                
                <div class="filter-tabs">
                    <div class="filter-tab active" onclick="filterTransactions('all')">All</div>
                    <div class="filter-tab" onclick="filterTransactions('earning')">Earnings</div>
                    <div class="filter-tab" onclick="filterTransactions('withdrawal')">Withdrawals</div>
                    <div class="filter-tab" onclick="filterTransactions('bonus')">Bonuses</div>
                </div>
            </div>
            
            <div class="transactions-list" id="transactionsList">
                <!-- Transactions will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Withdrawal Confirmation Modal -->
    <div class="modal-overlay" id="withdrawalModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-check-circle"></i> Confirm Withdrawal</h3>
            </div>
            <div class="modal-content">
                <p>You are about to withdraw <strong id="modalAmount">₹0</strong> to <strong id="modalUpiId"></strong>.</p>
                <p style="margin-top: 10px;">Withdrawal requests are processed within 24-48 hours. A confirmation email will be sent once approved.</p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmWithdrawal()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Add Funds Modal -->
    <div class="modal-overlay" id="addFundsModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Add Funds</h3>
            </div>
            <div class="modal-content">
                <div class="amount-options" style="margin-bottom: 20px;">
                    <div class="amount-option" onclick="setAddAmount(100)">₹100</div>
                    <div class="amount-option" onclick="setAddAmount(200)">₹200</div>
                    <div class="amount-option active" onclick="setAddAmount(500)">₹500</div>
                    <div class="amount-option" onclick="setAddAmount(1000)">₹1000</div>
                </div>
                
                <div class="form-group">
                    <label for="addAmount">Custom Amount (₹)</label>
                    <div class="input-group">
                        <i class="fas fa-rupee-sign"></i>
                        <input type="number" id="addAmount" placeholder="Enter amount" min="100" max="10000">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Select Wallet</label>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1; text-align: center; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; cursor: pointer;"
                             onclick="selectWallet('purchase')" id="purchaseWalletBtn">
                            <div style="font-weight: 600; color: white;">Purchase</div>
                            <div style="font-size: 12px; color: #94a3b8;">For buying plans</div>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 15px; background: rgba(255, 255, 255, 0.07); border-radius: 10px; cursor: pointer;"
                             onclick="selectWallet('main')" id="mainWalletBtn">
                            <div style="font-weight: 600; color: white;">Main</div>
                            <div style="font-size: 12px; color: #94a3b8;">For withdrawals</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn confirm" onclick="proceedToPayment()">Proceed to Payment</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="mining.html" class="nav-item">
            <i class="fas fa-digging"></i>
            <span>Mining</span>
        </a>
        <a href="plans.html" class="nav-item">
            <i class="fas fa-gem"></i>
            <span>Plans</span>
        </a>
        <a href="wallet.html" class="nav-item active">
            <i class="fas fa-wallet"></i>
            <span>Wallet</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://qvbvgpzmwomtcvejkibs.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2YnZncHptd29tdGN2ZWpraWJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NjE1NDksImV4cCI6MjA4MTEzNzU0OX0.B7ED7dNB3Gdkq8mw20Y5iTixqvxl73UJYTHgKyLfSLs';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let user = null;
        let wallet = null;
        let transactions = [];
        let selectedWallet = 'purchase';
        let addAmount = 500;

        // Check authentication
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            user = session.user;
            await loadWalletData();
        }

        // Load wallet data
        async function loadWalletData() {
            document.getElementById('loading').classList.add('active');
            
            try {
                // Get wallet
                const { data: walletData } = await supabase
                    .from('wallets')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                wallet = walletData;
                
                // Get wallet transactions
                const { data: transactionsData } = await supabase
                    .from('wallet_transactions')
                    .select('*')
                    .eq('wallet_id', wallet.id)
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                transactions = transactionsData || [];
                
                // Get withdrawal history
                const { data: withdrawals } = await supabase
                    .from('withdrawals')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                // Update UI
                updateUI(walletData, transactionsData, withdrawals);
                
            } catch (error) {
                console.error('Error loading wallet data:', error);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // Update UI
        function updateUI(walletData, transactionsData, withdrawals) {
            // Update balances
            document.getElementById('mainBalance').textContent = `₹${walletData?.main_balance?.toFixed(2) || '0.00'}`;
            document.getElementById('bonusBalance').textContent = `₹${walletData?.bonus_balance?.toFixed(2) || '0.00'}`;
            document.getElementById('purchaseBalance').textContent = `₹${walletData?.purchase_balance?.toFixed(2) || '0.00'}`;
            
            // Set default withdrawal amount
            setAmount(200);
            
            // Render transactions
            renderTransactions(transactionsData, withdrawals);
        }

        // Render transactions
        function renderTransactions(transactionsData, withdrawals) {
            const container = document.getElementById('transactionsList');
            
            if ((!transactionsData || transactionsData.length === 0) && 
                (!withdrawals || withdrawals.length === 0)) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <h3>No transactions yet</h3>
                        <p>Your transaction history will appear here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            // Combine and sort all transactions
            let allTransactions = [];
            
            // Add wallet transactions
            if (transactionsData) {
                transactionsData.forEach(tx => {
                    allTransactions.push({
                        type: 'transaction',
                        data: tx,
                        date: new Date(tx.created_at)
                    });
                });
            }
            
            // Add withdrawals
            if (withdrawals) {
                withdrawals.forEach(wd => {
                    allTransactions.push({
                        type: 'withdrawal',
                        data: wd,
                        date: new Date(wd.created_at)
                    });
                });
            }
            
            // Sort by date (newest first)
            allTransactions.sort((a, b) => b.date - a.date);
            
            // Display transactions
            allTransactions.forEach(item => {
                if (item.type === 'transaction') {
                    renderTransactionItem(item.data);
                } else {
                    renderWithdrawalItem(item.data);
                }
            });
        }

        // Render transaction item
        function renderTransactionItem(transaction) {
            const container = document.getElementById('transactionsList');
            
            const item = document.createElement('div');
            item.className = 'transaction-item';
            
            let icon = '';
            let title = '';
            let description = '';
            let amountClass = '';
            
            switch(transaction.transaction_type) {
                case 'mining':
                    icon = '<i class="fas fa-digging"></i>';
                    title = 'Mining Earnings';
                    description = new Date(transaction.created_at).toLocaleString();
                    amountClass = 'earning';
                    break;
                case 'referral':
                    icon = '<i class="fas fa-users"></i>';
                    title = 'Referral Bonus';
                    description = new Date(transaction.created_at).toLocaleString();
                    amountClass = 'earning';
                    break;
                case 'purchase':
                    icon = '<i class="fas fa-shopping-cart"></i>';
                    title = 'Plan Purchase';
                    description = new Date(transaction.created_at).toLocaleString();
                    amountClass = 'bonus';
                    break;
                case 'bonus':
                    icon = '<i class="fas fa-gift"></i>';
                    title = 'Bonus Credit';
                    description = new Date(transaction.created_at).toLocaleString();
                    amountClass = 'bonus';
                    break;
            }
            
            item.innerHTML = `
                <div class="transaction-info">
                    <div class="transaction-icon ${amountClass}">
                        ${icon}
                    </div>
                    <div class="transaction-details">
                        <h4>${title}</h4>
                        <p>${description}</p>
                    </div>
                </div>
                <div class="transaction-amount">
                    <div class="amount ${amountClass}">+₹${transaction.amount?.toFixed(2)}</div>
                </div>
            `;
            
            container.appendChild(item);
        }

        // Render withdrawal item
        function renderWithdrawalItem(withdrawal) {
            const container = document.getElementById('transactionsList');
            
            const item = document.createElement('div');
            item.className = 'transaction-item';
            
            let statusClass = '';
            let statusText = '';
            
            switch(withdrawal.status) {
                case 'pending':
                    statusClass = 'pending';
                    statusText = 'Pending';
                    break;
                case 'approved':
                    statusClass = 'approved';
                    statusText = 'Approved';
                    break;
                case 'rejected':
                    statusClass = 'rejected';
                    statusText = 'Rejected';
                    break;
                case 'processing':
                    statusClass = 'pending';
                    statusText = 'Processing';
                    break;
            }
            
            item.innerHTML = `
                <div class="transaction-info">
                    <div class="transaction-icon withdrawal">
                        <i class="fas fa-download"></i>
                    </div>
                    <div class="transaction-details">
                        <h4>Withdrawal Request</h4>
                        <p>${new Date(withdrawal.created_at).toLocaleString()}</p>
                        <p style="font-size: 12px; margin-top: 5px;">UPI: ${withdrawal.upi_id}</p>
                    </div>
                </div>
                <div class="transaction-amount">
                    <div class="amount">-₹${withdrawal.amount?.toFixed(2)}</div>
                    <div class="status ${statusClass}">${statusText}</div>
                </div>
            `;
            
            container.appendChild(item);
        }

        // Set withdrawal amount
        function setAmount(amount) {
            document.getElementById('withdrawalAmount').value = amount;
            
            // Update active state
            document.querySelectorAll('.amount-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            event?.currentTarget?.classList.add('active');
        }

        // Set add funds amount
        function setAddAmount(amount) {
            addAmount = amount;
            document.getElementById('addAmount').value = amount;
            
            // Update active state
            event?.currentTarget?.parentElement?.querySelectorAll('.amount-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            event?.currentTarget?.classList.add('active');
        }

        // Select wallet for adding funds
        function selectWallet(walletType) {
            selectedWallet = walletType;
            
            // Update UI
            const purchaseBtn = document.getElementById('purchaseWalletBtn');
            const mainBtn = document.getElementById('mainWalletBtn');
            
            if (walletType === 'purchase') {
                purchaseBtn.style.background = 'rgba(99, 102, 241, 0.1)';
                mainBtn.style.background = 'rgba(255, 255, 255, 0.07)';
            } else {
                purchaseBtn.style.background = 'rgba(255, 255, 255, 0.07)';
                mainBtn.style.background = 'rgba(99, 102, 241, 0.1)';
            }
        }

        // Withdraw funds
        function withdrawFunds() {
            const amount = document.getElementById('withdrawalAmount').value;
            const upiId = document.getElementById('upiId').value;
            
            if (!amount || amount < 100) {
                alert('Minimum withdrawal amount is ₹100');
                return;
            }
            
            if (amount > 250) {
                alert('Maximum withdrawal per day is ₹250');
                return;
            }
            
            if (!upiId || !upiId.includes('@')) {
                alert('Please enter a valid UPI ID');
                return;
            }
            
            if (amount > wallet.main_balance) {
                alert(`Insufficient balance! You have ₹${wallet.main_balance.toFixed(2)}`);
                return;
            }
            
            // Show confirmation modal
            document.getElementById('modalAmount').textContent = `₹${amount}`;
            document.getElementById('modalUpiId').textContent = upiId;
            document.getElementById('withdrawalModal').classList.add('active');
        }

        // Confirm withdrawal
        async function confirmWithdrawal() {
            const amount = document.getElementById('withdrawalAmount').value;
            const upiId = document.getElementById('upiId').value;
            
            try {
                // Check if user has already withdrawn today
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const { data: todayWithdrawals } = await supabase
                    .from('withdrawals')
                    .select('amount')
                    .eq('user_id', user.id)
                    .eq('status', 'approved')
                    .gte('created_at', today.toISOString());
                
                let totalWithdrawnToday = 0;
                if (todayWithdrawals) {
                    totalWithdrawnToday = todayWithdrawals.reduce((sum, w) => sum + w.amount, 0);
                }
                
                if (totalWithdrawnToday + parseFloat(amount) > 250) {
                    alert(`Daily withdrawal limit reached! You've already withdrawn ₹${totalWithdrawnToday.toFixed(2)} today.`);
                    closeModal();
                    return;
                }
                
                // Create withdrawal request
                const { data, error } = await supabase
                    .from('withdrawals')
                    .insert([{
                        user_id: user.id,
                        amount: parseFloat(amount),
                        upi_id: upiId,
                        status: 'pending'
                    }]);
                
                if (error) throw error;
                
                // Update wallet balance
                await supabase
                    .from('wallets')
                    .update({
                        main_balance: wallet.main_balance - parseFloat(amount)
                    })
                    .eq('user_id', user.id);
                
                // Add transaction record
                await supabase
                    .from('wallet_transactions')
                    .insert([{
                        wallet_id: wallet.id,
                        amount: parseFloat(amount),
                        transaction_type: 'withdrawal',
                        description: `Withdrawal to ${upiId}`
                    }]);
                
                alert('Withdrawal request submitted successfully! It will be processed within 24-48 hours.');
                closeModal();
                await loadWalletData(); // Reload data
                
            } catch (error) {
                console.error('Error processing withdrawal:', error);
                alert('Failed to process withdrawal. Please try again.');
            }
        }

        // Show add funds modal
        function showAddFundsModal() {
            document.getElementById('addFundsModal').classList.add('active');
            setAddAmount(500);
            selectWallet('purchase');
        }

        // Proceed to payment
        function proceedToPayment() {
            const amount = document.getElementById('addAmount').value || addAmount;
            
            if (!amount || amount < 100) {
                alert('Minimum amount is ₹100');
                return;
            }
            
            // In a real app, you would redirect to payment gateway
            // For now, we'll simulate payment
            alert(`Redirecting to payment gateway for ₹${amount}...`);
            
            // Simulate successful payment after 2 seconds
            setTimeout(async () => {
                try {
                    const field = selectedWallet === 'purchase' ? 'purchase_balance' : 'main_balance';
                    const newBalance = wallet[field] + parseFloat(amount);
                    
                    await supabase
                        .from('wallets')
                        .update({ [field]: newBalance })
                        .eq('user_id', user.id);
                    
                    // Add transaction record
                    await supabase
                        .from('wallet_transactions')
                        .insert([{
                            wallet_id: wallet.id,
                            amount: parseFloat(amount),
                            transaction_type: selectedWallet === 'purchase' ? 'purchase' : 'bonus',
                            description: `Added funds to ${selectedWallet} wallet`
                        }]);
                    
                    alert(`Successfully added ₹${amount} to your ${selectedWallet} wallet!`);
                    closeModal();
                    await loadWalletData(); // Reload data
                    
                } catch (error) {
                    console.error('Error adding funds:', error);
                    alert('Failed to add funds. Please try again.');
                }
            }, 2000);
        }

        // Close modal
        function closeModal() {
            document.getElementById('withdrawalModal').classList.remove('active');
            document.getElementById('addFundsModal').classList.remove('active');
        }

        // Filter transactions
        function filterTransactions(type) {
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // In a real app, you would filter the transactions
            // For now, we'll just reload all
            loadWalletData();
        }

        // Request withdrawal
        function requestWithdrawal() {
            withdrawFunds();
        }

        // Real-time updates
        function setupRealtime() {
            const channel = supabase.channel('wallet_updates')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'wallets',
                        filter: `user_id=eq.${user.id}`
                    }, 
                    () => {
                        loadWalletData(); // Reload when wallet changes
                    }
                )
                .subscribe();
        }

        // Initialize
        checkAuth().then(() => {
            setupRealtime();
        });
    </script>
</body>
</html>
